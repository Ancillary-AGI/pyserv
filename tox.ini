[tox]
envlist = py{38,39,310,311,312}, lint, typecheck, docs
skip_missing_interpreters = true
isolated_build = true

[testenv]
deps =
    -r requirements.txt
    pytest>=6.0.0
    pytest-asyncio>=0.15.0
    pytest-cov>=2.0.0
    pytest-xdist>=2.0.0
    pytest-mock>=3.6.0
    coverage>=5.5
setenv =
    PYTHONPATH = {toxinidir}/src
    PYTHONDONTWRITEBYTECODE = 1
commands =
    pytest {posargs:--cov=pyserv  --cov-report=term-missing --cov-report=html --cov-report=xml}

[testenv:lint]
deps =
    flake8>=3.9.0
    black>=21.0.0
    isort>=5.0.0
    pre-commit>=2.15.0
skip_install = true
commands =
    flake8 src/pyserv tests
    black --check --diff src/pyserv tests
    isort --check-only --diff src/pyserv tests
    pre-commit run --all-files

[testenv:typecheck]
deps =
    mypy>=0.800
    types-all
setenv =
    PYTHONPATH = {toxinidir}/src
commands =
    mypy src/pyserv

[testenv:format]
deps =
    black>=21.0.0
    isort>=5.0.0
skip_install = true
commands =
    black src/pyserv tests
    isort src/pyserv tests

[testenv:docs]
deps =
    sphinx>=4.0.0
    sphinx-rtd-theme>=1.0.0
    sphinx-autodoc-typehints>=1.12.0
    myst-parser>=0.16.0
    sphinx-copybutton>=0.4.0
changedir = docs
commands =
    sphinx-build -b html . _build/html

[testenv:security]
deps =
    bandit>=1.7.0
    safety>=2.0.0
commands =
    bandit -r src/pyserv -c .bandit.yml
    safety check

[testenv:performance]
deps =
    pytest>=6.0.0
    pytest-benchmark>=3.4.0
setenv =
    PYTHONPATH = {toxinidir}/src
commands =
    pytest tests/performance/ -v --benchmark-only --benchmark-histogram

[testenv:build]
deps =
    build>=0.7.0
    twine>=3.4.0
skip_install = true
commands =
    python -m build
    twine check dist/*

[testenv:publish]
deps =
    build>=0.7.0
    twine>=3.4.0
passenv =
    TWINE_USERNAME
    TWINE_PASSWORD
    TWINE_REPOSITORY
    TWINE_REPOSITORY_URL
skip_install = true
commands =
    python -m build
    twine upload dist/*

[flake8]
max-line-length = 88
extend-ignore = E203, W503
exclude =
    .git,
    __pycache__,
    build,
    dist,
    .tox,
    .venv,
    venv,
    env,
    .eggs,
    *.egg,
    .mypy_cache,
    .pytest_cache,
    htmlcov,
    .coverage,
    docs/_build

[isort]
profile = black
multi_line_output = 3
line_length = 88
known_first_party = pyserv 
known_third_party =
    uvloop,
    httptools,
    jinja2,
    pydantic,
    cryptography,
    pyjwt,
    bcrypt,
    redis,
    pymongo,
    sqlalchemy,
    alembic,
    prometheus_client,
    structlog,
    sentry_sdk,
    web3,
    motor,
    aiofiles,
    python_multipart,
    itsdangerous,
    click,
    rich,
    typer,
    email_validator,
    python_dotenv

[bandit]
exclude_dirs = tests
skips = B101,B601




